{% extends 'base/webtv_header.html'%}
{% block content %}

    <div class="status">
        <div class="vertical-center">
            輪候狀況 Queue Status
        </div>
        
    </div>

   
    <div id="calling_area">
    {% for ticketrow in ticketlist %}            
        <div class="container_calling">
            <div class="ticketno">
                {{ticketrow.tickettemp.tickettype}}{{ticketrow.tickettemp.ticketnumber}}
            </div>
            <div class="counter">
                <div class="countertype" >{{ticketrow.countertype.lang1}} {{ticketrow.countertype.lang2}}</div>
                <div class="counternumber">{{ticketrow.counternumber}}</div>
            </div>
            
            <div class="card-body">
                <div class="numberCircle">
                    {{ticketlist.0.wait}}
                    <!-- <div class="vertical-center"> -->
                        <!-- <div  style="align-self: center;background: none;">
                            
                        </div> -->
                           
                    <!-- </div> -->
                 
                    </div>
                
                <!-- <div class="countertype">Waiting list</div>
                <div id="cc1_wait" class="counternumber">{{ticketlist.0.wait}}</div> -->
            </div>
           
        </div>

    {% endfor %}
    </div>
  

    <div class="powered">Powered by tsvd.com.hk</div>

    {{ bcode|json_script:"js-bcode" }}
    {{ ct|json_script:"js-ct" }}
    <script>
        var ticketlist = [];
        const c_bcode = JSON.parse(document.getElementById('js-bcode').textContent);
        const c_ct = JSON.parse(document.getElementById('js-ct').textContent);
        
        document.querySelectorAll(".status > .vertical-center")[0].innerHTML = window.location.host;
        
        // const containers = document.getElementsByClassName("container_calling");
        // const numContainers = containers.length;
        // console.log(numContainers); // Output: 3

        // var cc1 = document.getElementsByClassName('container_calling')[0].innerHTML;
        // console.log(cc1);

        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/webtv/'
            + c_bcode
            + '/'
            + c_ct
            + '/'
        );

        chatSocket.onmessage = function(e) {
            // console.log('Received data:', e.data);
            const data = JSON.parse(e.data);
            // console.log('Parsed data:', data);
            document.querySelectorAll(".status > .vertical-center")[0].innerHTML = data.lastupdate;
            
            document.querySelector('#ws-lastupdate').innerHTML = data.lastupdate;
            document.querySelector('#calling_area').innerHTML = ``;

            ticketlist = JSON.parse(data.ticketlist);
            // console.log(data.ticketlist);
            for (var i = 0; i < ticketlist.length; i++) {
                var obj = ticketlist[i];
                // console.log("Ticket Type: " + obj.tickettype);
                // console.log("Ticket Number: " + obj.ticketnumber);
                // console.log("Language 1: " + obj.lang1);
                // console.log("Language 2: " + obj.lang2);
                // console.log("Counter Number: " + obj.counternumber);
                // console.log("Wait Time: " + obj.wait);

                document.querySelector('#calling_area').innerHTML = 
                document.querySelector('#calling_area').innerHTML +
                `<div class="container_calling">
                    <div class="ticketno">` + 
                        obj.tickettype + obj.ticketnumber +
                    `</div>
                    <div class="counter">
                        <div class="countertype">` +
                            obj.lang1 + ` ` + obj.lang2 + 
                        `</div>
                        <div class="counternumber">`
                            + obj.counternumber +
                        `</div>
                    </div>
                </div>`;


            }
            // document.querySelector('#chat-log').value += ('testing' + '\n');
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };        
    </script>



{% endblock content %}
